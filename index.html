<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Our Special Dates</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;600&display=swap');
    body {
      font-family: 'Quicksand', sans-serif;
      background-color: #2e2b3f;
      background-image: url('https://www.transparenttextures.com/patterns/hearts.png');
      background-size: contain;
      color: #f8d1d7;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      color: #ff9ff3;
      text-align: center;
      font-size: 2.5em;
      font-family: 'Pacifico', cursive;
      animation: heartbeat 1.5s infinite;
    }
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    button {
      background-color: #ff6b81;
      color: white;
      padding: 10px 15px;
      border: none;
      font-size: 16px;
      margin: 10px 0;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #ee5253; }
    .form-section {
      margin-bottom: 20px;
      background: #3c3452;
      padding: 15px;
      border-radius: 8px;
      display: none;
    }
    input[type="text"], input[type="date"], select {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #544a69;
      color: #f8d1d7;
    }
    .date-entry {
      background: #483c5a;
      padding: 15px;
      border-left: 4px solid #ff6b81;
      margin-bottom: 15px;
      border-radius: 5px;
      transition: transform 0.3s ease;
    }
    .date-entry:hover {
      transform: scale(1.01);
    }
    .countdown {
      font-weight: bold;
      color: #feca57;
    }
    .actions { margin-top: 10px; }
    .actions button {
      margin-right: 10px;
      background-color: #576574;
    }
    .actions button.delete { background-color: #ff6b6b; }
    #popup {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff6b81;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    #authButtons {
      text-align: center;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>ðŸ’– Our Special Dates</h1>
  <div id="popup">Saved!</div>
  <div id="authButtons">
    <button onclick="signIn()">Sign In with Google</button>
    <button onclick="signOut()">Sign Out</button>
  </div>
  <button id="addBtn" onclick="toggleForm()" style="display:none">+ Add Special Date</button>
  <div class="form-section">
    <input type="text" id="title" placeholder="Title (e.g. Anniversary)" />
    <input type="date" id="date" />
    <select id="repeatType">
      <option value="none">One-time</option>
      <option value="yearly">Yearly</option>
      <option value="monthly">Monthly</option>
    </select>
    <button onclick="saveDate()">Save</button>
  </div>
  <div>
    <label for="sortSelect">Sort by:</label>
    <select id="sortSelect" onchange="renderDates()">
      <option value="upcoming">Upcoming</option>
      <option value="oldest">Oldest</option>
      <option value="newest">Newest</option>
    </select>
  </div>
  <div id="datesContainer" style="display:none"></div>
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const allowedEmails = [
      "manthandalmia2@gmail.com",
      "shubhi.schedule@gmail.com"
    ];

    auth.onAuthStateChanged(user => {
      const form = document.querySelector('.form-section');
      const addButton = document.getElementById('addBtn');
      const datesContainer = document.getElementById('datesContainer');
      const authButtons = document.getElementById('authButtons');

      if (user) {
        if (!allowedEmails.includes(user.email)) {
          alert(`Access denied for ${user.email}`);
          auth.signOut();
          return;
        }

        authButtons.style.display = 'none';
        addButton.style.display = 'inline-block';
        datesContainer.style.display = 'block';
        renderDates();
      } else {
        authButtons.style.display = 'block';
        form.style.display = 'none';
        addButton.style.display = 'none';
        datesContainer.style.display = 'none';
      }
    });

    function signIn() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    }

    function signOut() {
      auth.signOut();
    }

    function toggleForm() {
      const form = document.querySelector('.form-section');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    async function saveDate() {
      const title = document.getElementById('title').value;
      const date = document.getElementById('date').value;
      const repeatType = document.getElementById('repeatType').value;
      const user = auth.currentUser;

      if (!title || !date || !user) return;

      await db.collection('dates').add({
        uid: user.uid,
        title,
        date,
        repeatType,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      document.getElementById('popup').style.display = 'block';
      setTimeout(() => document.getElementById('popup').style.display = 'none', 2000);
      renderDates();
    }

    async function renderDates() {
      const user = auth.currentUser;
      if (!user) return;

      const sort = document.getElementById('sortSelect').value;
      let ref = db.collection('dates').where('uid', '==', user.uid);
      if (sort === 'oldest') ref = ref.orderBy('createdAt', 'asc');
      else if (sort === 'newest') ref = ref.orderBy('createdAt', 'desc');

      const snapshot = await ref.get();
      const container = document.getElementById('datesContainer');
      container.innerHTML = '';

      const now = new Date();

      snapshot.docs.forEach(doc => {
        const data = doc.data();
        const eventDate = new Date(data.date);
        let countdownText = '';

        const diffMs = eventDate.getTime() - now.getTime();
        const past = diffMs < 0;

        if (data.repeatType === 'yearly') {
          let thisYear = new Date(now.getFullYear(), eventDate.getMonth(), eventDate.getDate());
          if (thisYear < now) thisYear.setFullYear(now.getFullYear() + 1);
          countdownText = `${Math.ceil((thisYear - now) / (1000 * 60 * 60 * 24))} days until next`;
        } else if (data.repeatType === 'monthly') {
          let thisMonth = new Date(now.getFullYear(), now.getMonth(), eventDate.getDate());
          if (thisMonth < now) thisMonth.setMonth(thisMonth.getMonth() + 1);
          countdownText = `${Math.ceil((thisMonth - now) / (1000 * 60 * 60 * 24))} days until next`;
        } else {
          countdownText = `${Math.abs(Math.ceil(diffMs / (1000 * 60 * 60 * 24)))} days ${past ? 'ago' : 'left'}`;
        }

        const div = document.createElement('div');
        div.className = 'date-entry';
        div.innerHTML = `
          <strong>${data.title}</strong><br>
          <span>${eventDate.toDateString()}</span><br>
          <span class="countdown">${countdownText}</span>
        `;
        container.appendChild(div);
      });
    }
  </script>
</body>
</html>
